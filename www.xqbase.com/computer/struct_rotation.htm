<html>

<head>
<meta http-equiv="Content-Type"
content="text/html; charset=gb_2312-80">
<meta name="GENERATOR" content="Microsoft FrontPage Express 2.0">
<title>数据结构――旋转的位棋盘</title>
</head>

<body background="../background.gif">

<dl>
    <div align="center"><center>
    <dt><font size="3">《对弈程序基本技术》专题</font></dt>
    </center></div>
    <dt>　</dt>
    <div align="center"><center>
    <dt><font size="6" face="隶书">旋转的位棋盘</font></dt>
    </center></div><div align="center"><center>
    <dt>　</dt>
    </center></div><div align="center"><center>
    <dt>作者：<font face="Times New Roman">James Swafford</font></dt>
    </center></div>
    <dt>　</dt>
    <dt>　　“位棋盘”可以记录的最有用的棋盘状况之一就是“棋盘上哪些格子受到某一特定棋子的攻击”。幸运的是，这样的计算耗时不多。对于那些活动能力不强的棋子，这可以说非常容易<font
        face="Times New Roman">(</font>请看上节“位棋盘”<font
        face="Times New Roman">) </font>。原因是：当马，国王或兵在特定格子上时，无论周围情况怎样变化，所攻击的格子数目不变。你不用管那些格子上是否有棋子或者周围是否有特殊情况。</dt>
</dl>

<table border="0" width="100%">
    <tr>
        <td align="center">马在<font face="Times New Roman">D5</font>格可以攻击到的格子</td>
        <td align="center">国王在<font face="Times New Roman">D5</font>格可以攻击到的格子</td>
        <td align="center">黑棋的兵在<font
        face="Times New Roman">D5</font>格可以攻击到的格子</td>
    </tr>
    <tr>
        <td align="center"><img src="struct_rotation1.gif"
        width="192" height="192"></td>
        <td align="center"><img src="struct_rotation2.gif"
        width="192" height="192"></td>
        <td align="center"><img src="struct_rotation3.gif"
        width="192" height="192"></td>
    </tr>
</table>

<dl>
    <dt>　　但是对于车，象和皇后，事情就不那么简单了。例如，车攻击横线方向和竖线方向上的格子，直到在这两个方向遇到第一个有棋子的格子为止<font
        face="Times New Roman">(</font>包括这个有棋子的格子<font
        face="Times New Roman">)</font>；如果没有遇到有棋子的格子，则到棋盘边界为止。也就是说，车所在横线和竖线上的棋子分布情况不同，受到这个车攻击的格子的数量也不一样。因为每条横线或竖线都有<font
        face="Times New Roman">8</font>个格子，每个格子又有<font
        face="Times New Roman">2</font>种状态（有棋子或者没有棋子），所以每条横线或竖线都会有<font
        face="Times New Roman">2<sup>8</sup>(256)</font>种棋子分布状态。</dt>
    <dt>　</dt>
    <dt><font size="4" face="楷体_GB2312"><strong>用旋转的位棋盘计算受车攻击的格子</strong></font></dt>
    <dt>　</dt>
    <dt>　　如何获得整个棋盘上受到某个车攻击的格子呢？最简单的方法是：先计算出一个位棋盘记录车所在横线上受其攻击的格子，在计算出另一个位棋盘记录车所在竖线上受其攻击的格子，最后用“逻辑或”把这两个位棋盘“结合”到一起。</dt>
</dl>

<table border="0" width="100%">
    <tr>
        <td align="center"><table border="0">
            <tr>
                <td align="center"><img
                src="struct_rotation4.gif" width="192"
                height="192"></td>
                <td align="center"><font face="Times New Roman"><strong>OR</strong></font></td>
                <td align="center"><img
                src="struct_rotation5.gif" width="192"
                height="192"></td>
                <td align="center"><font face="Times New Roman"><strong>=</strong></font></td>
                <td align="center"><img
                src="struct_rotation6.gif" width="192"
                height="192"></td>
            </tr>
        </table>
        </td>
    </tr>
</table>

<dl>
    <dt>　　整个操作的关键在于“预先计算”。对于<font
        face="Times New Roman">64</font>格中的每一格，都预先计算出当车在这一格时，不同情况下横线上受到攻击的格子<font
        face="Times New Roman">(</font>共<font
        face="Times New Roman">256</font>种情况<font
        face="Times New Roman">)</font>和不同情况下竖线上受到攻击的格子<font
        face="Times New Roman">(</font>也是<font
        face="Times New Roman">256</font>种<font
        face="Times New Roman">)</font>。当要寻找某一情况下受车攻击的格子时，用横线<font
        face="Times New Roman">(</font>或竖线<font
        face="Times New Roman">)</font>上的“棋子分布状态”作索引从预先计算出来的位棋盘数组中取得。</dt>
    <dt>　　所以，第一步：预先计算出数组<font
        face="Times New Roman">rank_attacks[64][256]</font>和<font
        face="Times New Roman">file_attacks[64][256]</font>。</dt>
    <dd>　</dd>
    <dd>/* 车或后横向移动的预先计算 */</dd>
    <dd>for (棋盘上的每一格)(0-63) {</dd>
    <dd>　for (每行的棋子分布状态)(0-255) {</dd>
    <dd>　　计算该状态下被占的格子</dd>
    <dd>　　计算从这个格子朝左走的着法</dd>
    <dd>　　计算从这个格子朝右走的着法</dd>
    <dd>　　rank_attacks[格子][横线状态] = attack_board;</dd>
    <dd>　}</dd>
    <dd>}</dd>
    <dd>/* 车或后纵向移动的预先计算 */</dd>
    <dd>for (棋盘上的每一格)(0-63) {</dd>
    <dd>　for (每条纵线的棋子分布状态)(0-255) {</dd>
    <dd>　　计算该状态下被占的格子</dd>
    <dd>　　计算从这个格子朝上走的着法</dd>
    <dd>　　计算从这个格子朝下走的着法</dd>
    <dd>　　file_attacks[格子][纵线状态] = attack_board;</dd>
    <dd>　}</dd>
    <dd>}</dd>
    <dt>　</dt>
    <dt>　　第二步：索引<font face="Times New Roman">rank_attacks[64][256]</font>，数组的第一个索引号为车所在格的编号。第二个索引号为车所在行上的“棋子分布状态”。</dt>
    <dt>　　请看下面这个例子：</dt>
</dl>

<table border="0" width="100%">
    <tr>
        <td align="center">车在<font face="Times New Roman">E6</font>格可以攻击到的格子</td>
    </tr>
    <tr>
        <td align="center"><img src="struct_rotation7.gif"
        width="256" height="256"></td>
    </tr>
</table>

<dl>
    <dt>　　第一个索引号是<font face="Times New Roman">E6</font>格的编号。在我的程序里，它的编号是<font
        face="Times New Roman">20</font>。第二个索引号是棋盘上第六行的棋子分布状态。</dt>
    <dd><font face="Times New Roman">0 1 0 1 0 0 1 0</font></dd>
    <dt>　　<font color="#0000FF">【编者注：在</font><font
        color="#0000FF" face="Times New Roman">James Swafford</font><font
        color="#0000FF">的程序里，由于</font><font
        color="#0000FF" face="Times New Roman">A8</font><font
        color="#0000FF">格编号为</font><font color="#0000FF"
        face="Times New Roman">0</font><font color="#0000FF">，所以这串数据的顺序正好和棋盘相反，跟黑方看上去的顺序相同。】</font></dt>
    <dt>　　要分离出上面这个数字，我们需要对位棋盘执行一个“位移<font
        face="Times New Roman">(shift)</font>”和一个“逻辑与”指令。在我的程序中，<font
        face="Times New Roman">A8</font>格的编号为<font
        face="Times New Roman">0</font>。如果车在第<font
        face="Times New Roman">8</font>行的任意格子上则不需要执行位移；若在第<font
        face="Times New Roman">7</font>行则要右移<font
        face="Times New Roman">8</font>位；在第<font
        face="Times New Roman">6</font>行要右移<font
        face="Times New Roman">16</font>位；以此类推。</dt>
</dl>

<table border="0" width="100%">
    <tr>
        <td align="center">需要右移的位数</td>
    </tr>
    <tr>
        <td align="center"><table border="1">
            <tr>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>0</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>0</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>0</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>0</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>0</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>0</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>0</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>0</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>8</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>8</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>8</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>8</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>8</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>8</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>8</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>8</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>16</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>16</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>16</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>16</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>16</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>16</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>16</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>16</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>24</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>24</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>24</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>24</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>24</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>24</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>24</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>24</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>32</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>32</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>32</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>32</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>32</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>32</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>32</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>32</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>40</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>40</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>40</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>40</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>40</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>40</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>40</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>40</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>48</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>48</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>48</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>48</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>48</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>48</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>48</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>48</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>56</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>56</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>56</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>56</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>56</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>56</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>56</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>56</strong></font></td>
            </tr>
        </table>
        </td>
    </tr>
</table>

<dl>
    <dt>　　我们需要第<font face="Times New Roman">6</font>行的棋子分布情况(从第<font
        face="Times New Roman">16</font>位到第<font
        face="Times New Roman">23</font>位)，就右移<font
        face="Times New Roman">16</font>位，现在它被右移到了最低的<font
        face="Times New Roman">8</font>位，我们把它与<font
        face="Times New Roman">255(0xff</font>)做逻辑与运算。所得到的东西即是我们需要作为<font
        face="Times New Roman">rank_attacks</font>的第二个索引号的数字。</dt>
    <dt>　</dt>
    <dt>　　第三步：索引数组<font
        face="Times New Roman">file_attacks[64][256]</font>。</dt>
    <dt>　　如何计算出<font face="Times New Roman">file_attacks</font>位棋盘呢？还是通过索引数组。和上面一样，第一个索引号是车所在格的编号。第二个索引号是车所在列的棋子分布状态。</dt>
    <dd><font face="Times New Roman">1</font></dd>
    <dd><font face="Times New Roman">0</font></dd>
    <dd><font face="Times New Roman">0</font></dd>
    <dd><font face="Times New Roman">0</font></dd>
    <dd><font face="Times New Roman">0</font></dd>
    <dd><font face="Times New Roman">1</font></dd>
    <dd><font face="Times New Roman">0</font></dd>
    <dd><font face="Times New Roman">1</font><font
        color="#0000FF">【编者注：同样道理，这是黑方看上去的位置。】</font></dd>
    <dt>　　要分离出这个索引号比分离<font
        face="Times New Roman">rank_attacks</font>的要复杂一些。仅执行“位移”和“与”指令是无法做到的。首先，我们要把棋盘右转<font
        face="Times New Roman">90</font>度<font color="#0000FF">【编者注：即顺时针转</font><font
        color="#0000FF" face="Times New Roman">90</font><font
        color="#0000FF">度。】</font>。因此现在它看上去应该是这个样子：</dt>
</dl>

<table border="0" width="100%">
    <tr>
        <td align="center">右转<font face="Times New Roman">90</font>度后的棋盘</td>
    </tr>
    <tr>
        <td align="center"><img src="struct_rotation8.gif"
        width="256" height="256"></td>
    </tr>
</table>

<dl>
    <dt>　　这个旋转后的棋盘是怎么得到的？你可以在开始做下一层搜索的时候构建这个棋盘，或者简单地在“走”下一步棋或“恢复”上一步棋的时候逐步更新它。下面的方法演示了如何在开始做下一层搜索时构建它。<font
        face="Times New Roman">(</font>代码并不那么优雅，但较易理解……<font
        face="Times New Roman">)</font></dt>
    <dd>　</dd>
    <dd>int r90R_map[64] = {</dd>
    <dd>　H8, H7, H6, H5, H4, H3, H2, H1,</dd>
    <dd>　G8, G7, G6, G5, G4, G3, G2, G1,</dd>
    <dd>　F8, F7, F6, F5, F4, F3, F2, F1,</dd>
    <dd>　E8, E7, E6, E5, E4, E3, E2, E1,</dd>
    <dd>　D8, D7, D6, D5, D4, D3, D2, D1,</dd>
    <dd>　C8, C7, C6, C5, C4, C3, C2, C1,</dd>
    <dd>　B8, B7, B6, B5, B4, B3, B2, B1,</dd>
    <dd>　A8, A7, A6, A5, A4, A3, A2, A1</dd>
    <dd>};</dd>
    <dd>BitBoard Rotated90R = 0;</dd>
    <dd>for (棋盘上的每一格)(0-63) {</dd>
    <dd>　if (格子被占)</dd>
    <dd>　　Rotated90R |= mask[r90R_map[square]];</dd>
    <dd>}</dd>
    <dt>　</dt>
    <dt>　　这样，原来在<font face="Times New Roman">A8</font>格上的棋子被“映射”到<font
        face="Times New Roman">H8</font>格上，原来在<font
        face="Times New Roman">H8</font>格上的棋子则被“映射”到<font
        face="Times New Roman">H1</font>格上……</dt>
    <dt>　　现在，我们可以对这个旋转后的位棋盘执行“位移”和“与”操作了。</dt>
    <dt>　</dt>
    <dt>　　第四步：获得<font face="Times New Roman">rook_attacks</font>位棋盘。</dt>
    <dt>　　得到<font face="Times New Roman">rank_attacks</font>和<font
        face="Times New Roman">file_attacks</font>位棋盘后，你只要简单的对这两个位棋盘执行“与”运算就获得了记录了所有受到那个车攻击的格子的位棋盘了。</dt>
    <dd>　</dd>
    <dd>rook_attack = rank_attack | file_attack;</dd>
    <dt>　</dt>
    <dt><font size="4" face="楷体_GB2312"><strong>用旋转的位棋盘计算受象攻击的格子</strong></font></dt>
    <dt>　</dt>
    <dt>　　计算受象攻击的格子的方法与车类似。对应于车的把横线与竖线做“或”运算，这里我们对象所在的两条斜线做“或”运算。我们把第一条斜线<font
        face="Times New Roman">(</font>就是执白时，从左上到右下这条斜线<font
        face="Times New Roman">)</font>叫做<font
        face="Times New Roman">diag_A8H1</font>；另一条斜线叫做<font
        face="Times New Roman">diag_H8A1</font>。相对车这里还多了一步，原因是每条斜线的长度不同。先预先计算出数组<font
        face="Times New Roman">diag_A8H1_attacks[64][256]</font>和<font
        face="Times New Roman">diag_H8A1_attacks[64][256]</font>。<font
        face="Times New Roman">A8</font>格编号为<font
        face="Times New Roman">0</font>，<font
        face="Times New Roman">H8</font>格为<font
        face="Times New Roman">7</font>，<font
        face="Times New Roman">A1</font>格为<font
        face="Times New Roman">56</font>，<font
        face="Times New Roman">H1</font>格为<font
        face="Times New Roman">63</font>。</dt>
    <dd>　</dd>
    <dd>int length_A8H1_diag[64] = {</dd>
    <dd>　8, 7, 6, 5, 4, 3, 2, 1,</dd>
    <dd>　7, 8, 7, 6, 5, 4, 3, 2,</dd>
    <dd>　6, 7, 8, 7, 6, 5, 4, 3,</dd>
    <dd>　5, 6, 7, 8, 7, 6, 5, 4,</dd>
    <dd>　4, 5, 6, 7, 8, 7, 6, 5,</dd>
    <dd>　3, 4, 5, 6, 7, 8, 7, 6,</dd>
    <dd>　2, 3, 4, 5, 6, 7, 8, 7,</dd>
    <dd>　1, 2, 3, 4, 5, 6, 7, 8</dd>
    <dd>};</dd>
    <dd>int length_H8A1_diag[64] = {</dd>
    <dd>　1, 2, 3, 4, 5, 6, 7, 8,</dd>
    <dd>　2, 3, 4, 5, 6, 7, 8, 7,</dd>
    <dd>　3, 4, 5, 6, 7, 8, 7, 6,</dd>
    <dd>　4, 5, 6, 7, 8, 7, 6, 5,</dd>
    <dd>　5, 6, 7, 8, 7, 6, 5, 4,</dd>
    <dd>　6, 7, 8, 7, 6, 5, 4, 3,</dd>
    <dd>　7, 8, 7, 6, 5, 4, 3, 2,</dd>
    <dd>　8, 7, 6, 5, 4, 3, 2, 1</dd>
    <dd>};</dd>
    <dd>/* 象或后在A8-H1方向移动的预先计算 */</dd>
    <dd>for (棋盘上的每一格)(0-63) {</dd>
    <dd>　/* 状态数会随对角线长度而变化 */</dd>
    <dd>　for (每条对角线的棋子分布状态)(0-(2^对角线长-1))
        {</dd>
    <dd>　　计算该状态下被占的格子(注意某些状态不要把8个格子都考虑进去)</dd>
    <dd>　　计算从这个格子朝左上方走的着法</dd>
    <dd>　　计算从这个格子朝右下方走的着法</dd>
    <dd>　　diag_A8H1_attacks[格子][状态] = attack_board;</dd>
    <dd>　}</dd>
    <dd>}</dd>
    <dd>/* 象或后在H8-A1方向移动的预先计算 */</dd>
    <dd>for (棋盘上的每一格)(0-63) {</dd>
    <dd>　/* 状态数会随对角线长度而变化 */</dd>
    <dd>　for (每条对角线的棋子分布状态)(0-(2^diag
        length)-1) {</dd>
    <dd>　　计算该状态下被占的格子(注意某些状态不要把8个格子都考虑进去)</dd>
    <dd>　　计算从这个格子朝右上方走的着法</dd>
    <dd>　　计算从这个格子朝左下方走的着法</dd>
    <dd>　　diag_H8A1_attacks[square][diag state] = attack_board;</dd>
    <dd>　}</dd>
    <dd>}</dd>
    <dt>　</dt>
    <dt>　　索引 <font face="Times New Roman">diag_A8H1_attacks[64][256]
        </font>数组。</dt>
    <dt>　　不说你也应该知道，第一个索引号是象所在格的编号。第二个索引号是它所在<font
        face="Times New Roman">A8-&gt;H1</font>方向斜线上的棋子分布情况。没错，接下去又要旋转位棋盘，位移，最后用“逻辑与”分离出我们需要的东东。为了对齐
        <font face="Times New Roman">A8-&gt;H1 </font>斜线上的格子，我们要把棋盘左转<font
        face="Times New Roman">45</font>度。<font
        face="Times New Roman">(</font>现在我建议你去拿罐可乐，外加一些提神的药物……<font
        face="Times New Roman">)</font></dt>
    <dd>　</dd>
    <dd>int r45L_map[64] = {</dd>
    <dd>　28, 21, 15, 10, 6, 3, 1, 0,</dd>
    <dd>　36, 29, 22, 16, 11, 7, 4, 2,</dd>
    <dd>　43, 37, 30, 23, 17, 12, 8, 5,</dd>
    <dd>　49, 44, 38, 31, 24, 18, 13, 9,</dd>
    <dd>　54, 50, 45, 39, 32, 25, 19, 14,</dd>
    <dd>　58, 55, 51, 46, 40, 33, 26, 20,</dd>
    <dd>　61, 59, 56, 52, 47, 41, 34, 27,</dd>
    <dd>　63, 62, 60, 57, 53, 48, 42, 35</dd>
    <dd>};</dd>
    <dt>　</dt>
    <dt>　　注意每个格子的映射次序，是从右上往左下的。这样映射后的位棋盘就会沿着<font
        face="Times New Roman">A8-H1</font>斜线对齐了<font
        face="Times New Roman">(</font>所有的斜线都是沿着这个方向走的<font
        face="Times New Roman">)</font>。</dt>
    <dt>　</dt>
    <dd>BitBoard Rotated45L = 0;</dd>
    <dd>for (棋盘上的每一格)(0-63) {</dd>
    <dd>　if square is not empty</dd>
    <dd>　otated45L |= mask[r45L_map[square]];</dd>
    <dd>}</dd>
    <dt>　</dt>
    <dt>　　现在“右移”这个棋盘，但是移动几位呢？</dt>
</dl>

<table border="0" width="100%">
    <tr>
        <td><p align="center">需要右移的位数</p>
        </td>
    </tr>
    <tr>
        <td align="center"><table border="1">
            <tr>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>15</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>10</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>6</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>3</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>1</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>0</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>15</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>10</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>6</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>3</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>1</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>43</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>15</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>10</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>6</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>3</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>49</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>43</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>15</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>10</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>6</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>54</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>49</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>43</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>15</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>10</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>58</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>54</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>49</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>43</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>15</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>61</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>58</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>54</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>49</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>43</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>21</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>63</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>61</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>58</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>54</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>49</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>43</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>28</strong></font></td>
            </tr>
        </table>
        </td>
    </tr>
</table>

<dl>
    <dt>　　位移完成后，最后一步就是用“屏蔽模版”将需要的数据分离出来。“屏蔽模版”根据斜线的长度不同而变化。</dt>
    <dt>　</dt>
    <dd>Mask_Length = (2 ^ diag_length) - 1;</dd>
    <dt>　</dt>
    <dt>　　按照这个公式，当斜线的长度为<font
        face="Times New Roman">7</font>时，屏蔽模版等于<font
        face="Times New Roman">127(</font>二进制：<font
        face="Times New Roman">1111111b</font>)。如果斜线的长度为<font
        face="Times New Roman">1</font>时屏蔽模版也为<font
        face="Times New Roman">1</font>。在程序中你可以用这个公式，但是使用查询表会更快一些。</dt>
    <dt>　</dt>
    <dt>　　索引 <font face="Times New Roman">diag_H8A1_attacks[64][256]
        </font>数组。</dt>
    <dt>　　为了对齐<font face="Times New Roman">H8-&gt;A1</font>方向的斜线，我们要把棋盘向右旋转<font
        face="Times New Roman">45</font>度。(再来一杯可乐？)</dt>
    <dt>　</dt>
    <dd>int r45R_map[64] = {</dd>
    <dd>　0, 1, 3, 6, 10, 15, 21, 28,</dd>
    <dd>　2, 4, 7, 11, 16, 22, 29, 36,</dd>
    <dd>　5, 8, 12, 17, 23, 30, 37, 43,</dd>
    <dd>　9, 13, 18, 24, 31, 38, 44, 49,</dd>
    <dd>　14, 19, 25, 32, 39, 45, 50, 54,</dd>
    <dd>　20, 26, 33, 40, 46, 51, 55, 58,</dd>
    <dd>　27, 34, 41, 47, 52, 56, 59, 61,</dd>
    <dd>　35, 42, 48, 53, 57, 60, 62, 63</dd>
    <dd>};</dd>
    <dd>BitBoard Rotated45R = 0;</dd>
    <dd>for (棋盘上的每一格)(0-63) {</dd>
    <dd>　if square is not empty</dd>
    <dd>　　Rotated45R |= mask[r45R_map[square]];</dd>
    <dd>}</dd>
</dl>

<table border="0" width="100%">
    <tr>
        <td><p align="center">需要右移的位数</p>
        </td>
    </tr>
    <tr>
        <td align="center"><table border="1">
            <tr>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>0</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>1</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>3</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>6</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>10</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>15</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>28</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>1</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>3</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>6</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>10</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>15</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>36</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>3</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>6</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>10</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>15</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>43</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>6</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>10</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>15</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>43</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>49</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>10</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>15</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>43</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>49</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>54</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>15</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>43</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>49</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>54</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>58</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>21</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>43</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>49</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>54</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>58</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>61</strong></font></td>
            </tr>
            <tr>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>28</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>36</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>43</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>49</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>54</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>58</strong></font></td>
                <td align="center" bgcolor="#000000"><font
                color="#FFFFFF" face="Times New Roman"><strong>61</strong></font></td>
                <td align="center" bgcolor="#FFFFFF"><font
                face="Times New Roman"><strong>63</strong></font></td>
            </tr>
        </table>
        </td>
    </tr>
</table>

<dl>
    <dt>　　最后，像对第一根斜线所做的那样，分离出所需数据。</dt>
    <dt>　　对这两个位棋盘做“逻辑或”，便得到记录受象攻击的格子的位棋盘。</dt>
    <dt>　</dt>
    <dd>bishop_attack = diag_A8H1_attacks | diag_H8A1_attacks;</dd>
    <dt>　</dt>
    <dt>　　最后，要得到受皇后攻击的格子的位棋盘，只要把受车攻击的格子“或”上受象攻击的格子：</dt>
    <dt>　</dt>
    <dd>queen_attack = rook_attack | bishop_attack;</dd>
    <dt>　</dt>
    <dt>　　出处：不详</dt>
    <dt>　　译者：<font face="Times New Roman">Allen Liu (</font><a
        href="http://lostboy.myrice.com/home.htm" target="_blank"><font
        color="#0000FF" face="Times New Roman">http://lostboy.myrice.com/</font></a><font
        face="Times New Roman">)</font></dt>
    <dt>　　类型：不详</dt>
    <dt>　　编辑：象棋百科全书网 <font
        face="Times New Roman">(</font><a
        href="mailto:webmaster@xqbase.com"><font
        face="Times New Roman">webmaster@xqbase.com</font></a><font
        face="Times New Roman">)</font></dt>
</dl>

<dir>
    <li>上一篇　<a href="struct_bitboard.htm">数据结构――位棋盘</a></li>
    <li>下一篇　<a href="struct_movegen.htm">数据结构――着法生成器</a></li>
    <li>返　回　<a href="../computer.htm">象棋百科全书――电脑象棋</a></li>
</dir>
<div align="center"><center>

<table border="0">
    <tr>
        <td><p align="center"><a
        href="http://www.xqbase.com/" target="_blank"><img
        src="../xqbase.gif" border="0" width="88"
        height="31"></a></p>
        </td>
    </tr>
    <tr>
        <td><a href="http://www.xqbase.com/"
        target="_blank"><font size="2" face="Arial"><strong>www.xqbase.com</strong></font></a></td>
    </tr>
</table>
</center></div>
</body>
</html>
